# Network - FTP

Created by : Mr Dk.

2020 / 12 / 17 11:33

Nanjing, Jiangsu, China

---

## About

FTP (File Transfer Protocolï¼Œæ–‡ä»¶ä¼ è¾“åè®®) æ˜¯ TCP/IP åè®®ç»„ä¸­çš„åè®®ä¹‹ä¸€ã€‚FTPåè®®åŒ…æ‹¬ä¸¤ä¸ªç»„æˆéƒ¨åˆ†ï¼Œå…¶ä¸€ä¸º FTP æœåŠ¡å™¨ï¼Œå…¶äºŒä¸º FTP å®¢æˆ·ç«¯ã€‚å…¶ä¸­ FTP æœåŠ¡å™¨ç”¨æ¥å­˜å‚¨æ–‡ä»¶ï¼Œç”¨æˆ·å¯ä»¥ä½¿ç”¨ FTP å®¢æˆ·ç«¯é€šè¿‡ FTP åè®®è®¿é—®ä½äº FTP æœåŠ¡å™¨ä¸Šçš„èµ„æºã€‚åœ¨å¼€å‘ç½‘ç«™çš„æ—¶å€™ï¼Œé€šå¸¸ä½¿ç”¨ FTP åè®®æŠŠç½‘é¡µæˆ–ç¨‹åºä¸Šä¼ åˆ° Web æœåŠ¡å™¨ä¸Šã€‚æ­¤å¤–ï¼Œç”±äº FTP ä¼ è¾“æ•ˆç‡éå¸¸é«˜ï¼Œåœ¨ç½‘ç»œä¸Šä¼ è¾“å¤§çš„æ–‡ä»¶æ—¶ï¼Œä¸€èˆ¬ä¹Ÿé‡‡ç”¨è¯¥åè®®ã€‚

FTP ä½¿ç”¨æ˜æ–‡ä¼ è¾“æ–‡ä»¶ï¼Œè€Œ SFTP (SSH File Transfer Protocol) å’Œ SCP (Secure Copy) ä½¿ç”¨åŠ å¯†é“¾è·¯ä¼ è¾“æ–‡ä»¶ï¼Œä¸¤è€…éƒ½æ˜¯ SSH (Secure Shell) æœåŠ¡çš„ä¸€éƒ¨åˆ†ã€‚

* SFTP å¯é æ€§é«˜ï¼Œå¯ **æ–­ç‚¹ç»­ä¼ **ï¼Œæ•ˆç‡æ¯” FTP ä½ä¸€äº›ï¼Œä½†æ›´å®‰å…¨
* SCP éœ€è¦çŸ¥é“ç›®æ ‡çš„è¯¦ç»†ç›®å½•ï¼Œä¸å¯æ–­ç‚¹ç»­ä¼ ï¼Œæ¯” SFTP æ›´ä¸ºè½»é‡çº§

## Working Mode

FTP ä½¿ç”¨ç†ŸçŸ¥ç«¯å£ TCP 21 ä½œä¸ºæ§åˆ¶ç«¯å£ï¼Œå‘é€æˆ–æ¥å—å‘½ä»¤ã€‚ä½†æ˜¯æ ¹æ®å·¥ä½œæ¨¡å¼ï¼Œè¿˜ä¼šå¼€è¾Ÿå…¶å®ƒç«¯å£ä½œä¸ºæ•°æ®ç«¯å£ã€‚

### Port Mode

FTP çš„ **ä¸»åŠ¨æ¨¡å¼**ã€‚å®¢æˆ·ç«¯é€šè¿‡ 21 ç«¯å£è¿æ¥åˆ°æœåŠ¡å™¨ã€‚å®¢æˆ·ç«¯åœ¨è‡ªèº«ä¸»æœºä¸Šå¼€è¾Ÿç«¯å£ç”¨äºæ•°æ®è¿æ¥ï¼Œå¹¶å°†è¿™ä¸ªç«¯å£é€šè¿‡ `PORT` å‘½ä»¤å‘Šè¯‰æœåŠ¡å™¨ã€‚æœåŠ¡å™¨ä½¿ç”¨è‡ªå·±çš„ TCP 20 ç«¯å£è¿æ¥åˆ°å®¢æˆ·ç«¯çš„æ•°æ®ç«¯å£ä¼ é€æ•°æ®ã€‚

> å¦‚æœå®¢æˆ·ç«¯æ²¡æœ‰å…¬ç½‘åœ°å€ (åœ¨å†…ç½‘ä»¥å†…)ï¼Œé‚£ä¹ˆæœåŠ¡å™¨æ²¡æœ‰åŠæ³•è¿æ¥åˆ°å®¢æˆ·ç«¯å¼€è¾Ÿçš„æ•°æ®ç«¯å£ä¸Šã€‚(é™¤éèƒ½å¤Ÿæ˜¾å¼ NATï¼Œä½†æ˜¯é€šå¸¸æ¥è¯´å®¢æˆ·ç«¯å¼€è¾Ÿçš„ç«¯å£æ˜¯éšæœºçš„)

### Passive Mode

FTP çš„ **è¢«åŠ¨æ¨¡å¼**ã€‚å®¢æˆ·ç«¯ä¾æ—§é€šè¿‡ 21 ç«¯å£è¿æ¥åˆ°æœåŠ¡å™¨ï¼Œå‘é€ `PASV` å‘½ä»¤ã€‚æœåŠ¡å™¨åœ¨è‡ªèº«ä¸»æœºä¸Šéšæœºæ‰“å¼€ä¸€ä¸ª **é«˜ç«¯ç«¯å£** (å¤§äº 1024)ï¼Œå¹¶å‘Šè¯‰å®¢æˆ·ç«¯è¿™ä¸ªç«¯å£çš„ä½ç½®ã€‚å®¢æˆ·ç«¯è¿æ¥åˆ°è¿™ä¸ªæœåŠ¡å™¨é«˜ç«¯ç«¯å£å»ºç«‹æ•°æ®è¿æ¥ã€‚é«˜ç«¯ç«¯å£çš„èŒƒå›´å¯ä»¥åœ¨ FTP æœåŠ¡å™¨ä¸Šè¿›è¡Œé…ç½®ã€‚

---

## Deploy && Install

è®°å½•æ˜¨å¤©éƒ¨ç½²ä¸€å° FTP æœåŠ¡å™¨çš„è¿‡ç¨‹ã€‚éœ€æ±‚æ˜¯æˆ‘çš„ä¸€å°å†…ç½‘ä¸»æœºä¸Šæ‹¥æœ‰å¤§é‡æ•°æ®éœ€è¦åˆ†äº«ç»™åˆ«äººï¼Œæ‰€ä»¥æƒ³è¦æ­å»ºä¸€å° FTP æœåŠ¡å™¨ï¼Œå¹¶ç»™å¯¹æ–¹å¼€æ”¾ä¸€ä¸ªè´¦æˆ·ã€‚å¯¹æ–¹èƒ½å¤Ÿç™»å½•åˆ°åŒ…å«æ•°æ®çš„æ–‡ä»¶å¤¹ä¸‹ï¼Œä½†ä¸å¸Œæœ›è¯¥è´¦æˆ·èƒ½è®¿é—®ä¸»æœºä¸Šçš„å…¶å®ƒæ•°æ®ã€‚å¦å¤–ï¼Œç”±äºä¸»æœºä½äºå†…ç½‘ä¸­ï¼Œè¿˜è¦é…ç½®å†…ç½‘ç©¿é€ã€‚

é€šè¿‡ APT å®‰è£… *vsftpd (very secure FTP daemon)*ï¼Œå®ƒæ˜¯ä¸€ä¸ªå®Œå…¨å…è´¹ã€å¼€æ”¾æºä»£ç çš„ FTP æœåŠ¡å™¨è½¯ä»¶ï¼Œè¿è¡Œåœ¨ UNIX ç±»æ“ä½œç³»ç»Ÿä¸Šã€‚å°å·§è½»å¿«ã€å®‰å…¨æ˜“ç”¨ã€‚

```bash
sudo apt install vsftpd
```

```console
$ service vsftpd status
â— vsftpd.service - vsftpd FTP server
     Loaded: loaded (/lib/systemd/system/vsftpd.service; enabled; vendor preset: enabled)
     Active: active (running) since Wed 2020-12-16 17:39:31 CST; 16h ago
   Main PID: 4224 (vsftpd)
      Tasks: 1 (limit: 38277)
     Memory: 16.6M
     CGroup: /system.slice/vsftpd.service
             â””â”€4224 /usr/sbin/vsftpd /etc/vsftpd.conf

12æœˆ 16 17:39:31 zjt-work-ubuntu-20 systemd[1]: Starting vsftpd FTP server...
12æœˆ 16 17:39:31 zjt-work-ubuntu-20 systemd[1]: Started vsftpd FTP server.
```

## Configuration

### Create User

åˆ›å»ºä¸€ä¸ªæ™®é€šç”¨æˆ·ï¼š

```bash
sudo adduser [--home DIR] [--shell SHELL]
```

åˆ›å»ºå®Œæ¯•åï¼Œå¯ä»¥åœ¨ `passwd` æ–‡ä»¶æœ€åçœ‹åˆ°ï¼š

```bash
cat /etc/passwd
```

åˆ é™¤ç”¨æˆ·ï¼š

```bash
sudo userdel [USER]
```

### White List / Black List

ç¼–è¾‘ vsftpd çš„é…ç½®æ–‡ä»¶ `/etc/vsftpd.conf` è¿›è¡Œé…ç½®ã€‚

é¦–å…ˆå¯åŠ¨ vsftpd çš„ user list åŠŸèƒ½ï¼Œè¯¥ç”¨æˆ·åˆ—è¡¨å¯ä»¥ä½œä¸ºé»‘åå•æˆ–ç™½åå•ä½¿ç”¨ã€‚åœ¨å½“å‰åœºæ™¯ä¸‹ï¼Œæˆ‘è‚¯å®šæ˜¯éœ€è¦ä¸€ä¸ªç™½åå•ï¼Œå¹¶å°†æä¾›ç»™å¯¹æ–¹çš„è´¦æˆ·åŠ å…¥åœ¨è¿™ä¸ªç™½åå•ä¸­ï¼Œè¿™æ ·åªæœ‰æä¾›ç»™ä»–çš„è´¦æˆ·æ‰å¯ä»¥è®¿é—®æ–‡ä»¶ã€‚

```
userlist_enable=YES
userlist_deny=NO
```

* `userlist_enable=YES` è¡¨ç¤ºå¯ç”¨ç”¨æˆ·åˆ—è¡¨æ–‡ä»¶ (é»˜è®¤åœ¨ `/etc/vsftpd.user_list`ï¼Œæ¯è¡Œä¸€ä¸ªè´¦æˆ·å)
* `userlist_deny=NO` è¡¨ç¤ºä¸æ‹’ç»åˆ—è¡¨ä¸­çš„è´¦æˆ· (å³ç™½åå•)

è¿™æ ·ï¼Œé™¤äº†åå•ä¸­æŒ‡å®šçš„è´¦æˆ·å¤–ï¼Œæˆ‘çš„ä¸»æœºé»˜è®¤è´¦æˆ·è¢«æ‹’ç»ç™»å½•ï¼š

```console
$ ftp localhost
Connected to localhost.
220 (vsFTPd 3.0.3)
Name (localhost:mrdrivingduck): mrdrivingduck
530 Permission denied.
Login failed.
```

### Chroot Jail

å°†ç”¨æˆ·ç™»å½•åçš„ root ç›®å½•é”å®šåœ¨ä¸€ä¸ªç‰¹å®šç›®å½•ä¸‹ï¼Œå½¢æˆä¸€ä¸ª *ç›‘ç‹±*ã€‚ç”¨æˆ·é€šè¿‡ `cd ..` å‘½ä»¤æ— æ³•é€ƒå‡ºè¿™ä¸ªç›‘ç‹±ï¼Œä»è€Œä¿è¯ç”¨æˆ·åªèƒ½è®¿é—®ç‰¹å®šçš„ç›®å½•ã€‚Linux çš„ `chroot` å‘½ä»¤èƒ½å¤Ÿåšåˆ°è¿™ä»¶äº‹ã€‚ç¼–è¾‘ `/etc/vsftpd.conf`ï¼š

```
chroot_local_user=NO
chroot_list_enable=YES
allow_writeable_chroot=NO
```

* `chroot_local_user` è¡¨ç¤ºä¸€ä¸ªå…¨å±€è®¾å®šï¼Œè®¾ç½®æ˜¯å¦å°†æ‰€æœ‰ç”¨æˆ·é”å®šåœ¨ jail å†…
* `chroot_list_enable` è¡¨ç¤ºæ˜¯å¦å¯ç”¨é’ˆå¯¹ç‰¹å®šç”¨æˆ·çš„ **ä¾‹å¤–** è®¾å®šï¼Œå³é»‘åå•æˆ–ç™½åå•ï¼Œå–å†³äº `chroot_local_user` çš„è®¾å®š - åå•æ–‡ä»¶é»˜è®¤ä½äº `/etc/vsftpd.chroot_list`
* `allow_writeable_chroot` - æ˜¯å¦å…è®¸ç”¨æˆ·ç™»å½•åè¢« chroot é”å®šçš„è·¯å¾„å¯å†™ (æ˜¯ä¸€ä¸ªå®‰å…¨ç­–ç•¥)

> å¦‚æœå°† `allow_writeable_chroot` è®¾ç½®ä¸º `NO`ï¼Œå¯èƒ½ä¼šé‡åˆ° `500 OOPS: vsftpd: refusing to run with writable root inside chroot ()` çš„é”™è¯¯ã€‚æœ‰ä¸¤ç§æ–¹æ³•å¯ä»¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚
>
> å°† `allow_writeable_chroot` è®¾ç½®ä¸º `YES` å¯ä»¥ç›´æ¥ç»•å¼€å®‰å…¨æ£€æŸ¥ï¼Œå…å»äº†å¾ˆå¤šä¸å¿…è¦çš„éº»çƒ¦ï¼Œä½†æ˜¯å¯èƒ½ä¼šå¸¦æ¥ **å®‰å…¨é—®é¢˜** ([ROARING BEAST ATTACK](https://serverfault.com/questions/743949/vsftp-why-is-allow-writeable-chroot-yes-a-bad-idea))ã€‚
>
> å¦ä¸€ç§æ–¹æ³•æ˜¯è®©ç”¨æˆ·è¢«é”å®šåˆ°çš„è·¯å¾„ **ä¸å¯å†™**ï¼Œä½†æ˜¯å¦‚æœéœ€è¦è·¯å¾„èƒ½å¤Ÿè¢«æµè§ˆï¼Œé‚£ä¹ˆå°±è¦ä¿ç•™è·¯å¾„çš„ **å¯è¯»** å’Œ **å¯æ‰§è¡Œ** æƒé™ã€‚å› æ­¤ï¼Œè¿™ç§æ–¹æ³•å®é™…ä¸Šæ˜¯æœ€å®‰å…¨çš„ã€‚
>
> æˆ‘æœ¬ä»¥ä¸ºå°†å¼€æ”¾è´¦æˆ·çš„ root è·¯å¾„ä¸‹çš„æ–‡ä»¶å¤¹æƒé™è®¾ç½®ä¸€ä¸‹å°±è¡Œäº†ã€‚æ²¡æƒ³åˆ°ï¼Œç”±äºæˆ‘å­˜æ”¾æ•°æ®çš„ NTFS æ–‡ä»¶ç³»ç»Ÿä½äºä¸€ä¸ªç§»åŠ¨ç¡¬ç›˜ä¸Šï¼Œä½¿ç”¨ `chmod` å±…ç„¶æ— æ³•æ›´æ”¹ç›®å½•æƒé™ ğŸ˜¥ã€‚å‚è€ƒ [è¿™ä¸ªè§£å†³æ–¹æ¡ˆ](http://blog.itpub.net/31536365/viewspace-2154308/) åï¼Œæˆ‘åªèƒ½åˆ° `/etc/fstab` ä¸­æ‰‹åŠ¨è®¾ç½®ï¼š
>
> * é€šè¿‡ `sudo fdisk -l` æŸ¥è¯¢è¿™ä¸ªç¡¬ç›˜çš„ UUID
> * é€šè¿‡ `cat /etc/passwd` æŸ¥è¯¢å½“å‰ä¸»æœºç”¨æˆ·çš„ uidã€gid
> * åœ¨ `/etc/fstab` ä¸­è®¾ç½®ç¡¬ç›˜æŒ‚è½½ç‚¹ã€è®¾ç½®ç›®å½•æ‹¥æœ‰è€…ä¸ºä¸»æœºç”¨æˆ·ã€ä¸»æœºç”¨æˆ·æ‹¥æœ‰ `7` æƒé™ã€å…¶å®ƒç”¨æˆ·åªæœ‰ `5` æƒé™ã€‚
>
> è¿™æ ·ï¼Œå¼€æ”¾è´¦æˆ·ç™»å½•åˆ°è¯¥è·¯å¾„åï¼Œå°†ä¸å…·æœ‰å†™æƒé™ï¼›è€Œæˆ‘çš„ä¸»æœºç”¨æˆ·å¯ä»¥ç»§ç»­å‘ç¡¬ç›˜ä¸­å†™å…¥æ•°æ®ã€‚

### Passive Mode && frp

ç”±äº FTP å®¢æˆ·ç«¯ä¹Ÿåœ¨å†…ç½‘ä¸­ï¼Œæ˜¾ç„¶ï¼ŒFTP æœåŠ¡å™¨æ— æ³•ä½¿ç”¨ä¸»åŠ¨æ¨¡å¼ï¼Œé‚£ä¹ˆéœ€è¦æ˜¾å¼å°† vsftpd é…ç½®ä¸º **è¢«åŠ¨æ¨¡å¼**ã€‚æ­¤å¤–ï¼Œè¿˜é‡åˆ°äº†ä¸€äº›é”™è¯¯ï¼Œé€šè¿‡å‚è€ƒ [è¿™ç¯‡æ–‡ç« ](https://blog.csdn.net/zengd0/article/details/109403079)ï¼Œè¿˜è¦åŠ ä¸€äº›é¢å¤–é…ç½®ã€‚åœ¨ `/etc/vsftpd.conf` ä¸­ï¼š

```
pasv_enable=YES
pasv_promiscuous=YES
pasv_address=118.31.10.213
pasv_addr_resolve=YES
listen_ipv6=NO
listen=YES
pasv_min_port=12792
pasv_max_port=12793
```

å…¶ä¸­ï¼Œ`pasv_address` æ˜¯ frp æœåŠ¡å™¨çš„è¿è¡Œåœ°å€ï¼Œæ˜¯å¿…é¡»çš„ï¼›`pasv_min_port` å’Œ `pasv_max_port` ç¡®å®šäº† FTP æœåŠ¡å™¨ä¸Šæ‰“å¼€æ•°æ®ç«¯å£çš„èŒƒå›´ï¼Œè¿™äº›ç«¯å£éœ€è¦è¢«ç©¿é€åˆ° frp æœåŠ¡å™¨çš„ç›¸åŒç«¯å£ä¸Šã€‚æ‰€ä»¥æ•´ä½“çš„ frp ç«¯å£ç©¿é€æ–¹æ¡ˆå¦‚ä¸‹ (åŒ…æ‹¬æ§åˆ¶ç«¯å£ 21)ï¼š

```ini
[ftp]
type = tcp
local_ip = 127.0.0.1
local_port = 21
remote_port = 2121

[frp-pasv-1]
type = tcp
local_ip = 127.0.0.1
local_port = 12792
remote_port = 12792

[frp-pasv-2]
type = tcp
local_ip = 127.0.0.1
local_port = 12793
remote_port = 12793
```

FTP å®¢æˆ·ç«¯åº”å½“ä»¥è¢«åŠ¨æ¨¡å¼è¿æ¥ frp æœåŠ¡å™¨çš„ `2121` (FTP æœåŠ¡å™¨æ§åˆ¶ç«¯å£çš„è¿œç¨‹ç«¯å£)ã€‚æ³¨æ„ï¼Œfrp çš„æ‰€æœ‰è¿œç¨‹ç«¯å£éƒ½åº”å½“åœ¨äº‘æœåŠ¡å™¨çš„å®‰å…¨ç»„ç™½åå•å†…ã€‚

### Others

Ubuntu 20.04 ä¸Šè¿˜å¯èƒ½åœ¨ vsftpd æœåŠ¡çš„æ—¥å¿—ä¸­çœ‹åˆ°é”™è¯¯ï¼Œè§£å†³æ–¹æ¡ˆ [åœ¨æ­¤](https://askubuntu.com/questions/1239503/ubuntu-20-04-and-20-10-etc-securetty-no-such-file-or-directory)ã€‚

---

## Summary

è¿™ç­‰æŠ˜è…¾ï¼Œvery interesting ğŸ˜„

## References

[CSDN - vsftpd -- ç”¨æˆ·åå•æ–‡ä»¶ ftpusers å’Œ user_list](https://blog.csdn.net/feit2417/article/details/82903314)

[CSDN - vsftpd é…ç½®: chroot_local_user ä¸ chroot_list_enable è¯¦è§£](https://blog.csdn.net/gybshen/article/details/79782884)

[Arch Linux - Very Secure FTP Daemon (ç®€ä½“ä¸­æ–‡)](https://wiki.archlinux.org/index.php/Very_Secure_FTP_Daemon_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87))

[Ben Scobie - Fixing 500 OOPS: vsftpd: refusing to run with writable root inside chroot ()](https://www.benscobie.com/fixing-500-oops-vsftpd-refusing-to-run-with-writable-root-inside-chroot/)

---

