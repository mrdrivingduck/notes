# Linux Performance - Perf Record

Created by: Mr Dk.

2023 / 09 / 18 20:55 ğŸ’£

Hangzhou, Zhejiang, China

---

## Background

`perf record` ç”¨äºé‡‡æ ·ç¨‹åºè¿è¡Œæ—¶çš„ç»Ÿè®¡ä¿¡æ¯å¹¶è®°å½•åˆ°æ–‡ä»¶ä¸­ã€‚é‡‡æ ·ç»“æœå¯ä»¥è¢«è½¬ç§»åˆ°å…¶å®ƒæœºå™¨ä¸Šè¿›è¡Œåˆ†æï¼Œéœ€è¦å’Œå…¶å®ƒ `perf` å­å‘½ä»¤é…åˆä½¿ç”¨ã€‚é‡‡æ ·çš„ç²’åº¦å¯ä»¥æ˜¯æ¯ä¸ªçº¿ç¨‹ã€æ¯ä¸ªè¿›ç¨‹ã€æ¯ä¸ª CPUã€æŸå‡ ç±»äº‹ä»¶ï¼Œç­‰ç­‰ã€‚

## Usage

æ–‡æ¡£è¿‡é•¿ï¼Œé€‰é¡¹è¿‡å¤šï¼Œæš‚ä¸ä¸€ä¸€è®°å½•ã€‚æ ¹æ®æ€§èƒ½åˆ†æå¤§å¸ˆ Brendan Gregg æä¾›çš„ä¸€äº› [One-Liners](https://www.brendangregg.com/perf.html)ï¼Œæ¯”è¾ƒå¸¸ç”¨çš„å‘½ä»¤ï¼š

```shell
# Sample CPU stack traces (via frame pointers) for the specified PID, at 99 Hertz, for 10 seconds:
perf record -F 99 -p PID -g -- sleep 10
```

å…¶ä¸­ï¼š

- `-F` è¡¨ç¤ºé‡‡æ ·é¢‘ç‡èµ«å…¹æ•°ï¼ˆæ¯ç§’é‡‡æ ·å¤šå°‘æ¬¡ï¼‰ï¼Œä»¥æ›´é«˜çš„é¢‘ç‡é‡‡æ ·ä¹Ÿå¯ä»¥ï¼Œä½†ä¼šå¸¦æ¥æ›´å¤šå¼€é”€ï¼›ä»¥ `99` Hz é‡‡æ ·å¯ä»¥ä¸ CPU æ—¶é’Ÿå‘¨æœŸé”™å¼€ï¼Œé˜²æ­¢é‡‡æ ·åˆ°ä¸€äº›å› æ—¶é’Ÿå‘¨æœŸè€Œäº§ç”Ÿçš„ç‰¹å®šè¡Œä¸º
- `-p` è¡¨ç¤ºè¢«é‡‡æ ·çš„è¿›ç¨‹å·ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªé€—å·åˆ†éš”çš„åˆ—è¡¨ï¼›`-t` åŒç†ï¼Œè¡¨ç¤ºçº¿ç¨‹å·
- `-a` è¡¨ç¤ºåœ¨æ‰€æœ‰ CPU ä¸Šé‡‡æ ·ï¼Œè‡ª Linux 4.11 å¼€å§‹å·²ç»æ˜¯é»˜è®¤é€‰é¡¹ï¼›é€šè¿‡ `-C` å¯ä»¥æŒ‡å®š CPU åˆ—è¡¨æˆ–èŒƒå›´é‡‡æ ·
- `-g` è¡¨ç¤ºè®°å½•é‡‡æ ·æ—¶çš„ç¨‹åºè°ƒç”¨æ ˆ
- `-- sleep 10` è¡¨ç¤ºé‡‡æ · 10s

`-e` å¯ä»¥æŒ‡å®šè®°å½•çš„äº‹ä»¶ã€‚ä»€ä¹ˆäº‹ä»¶éƒ½ä¸æŒ‡å®šæ—¶ï¼Œé»˜è®¤è¿½è¸ª `cycles` äº‹ä»¶ï¼ˆæ—¶é’Ÿå‘¨æœŸæ•°ï¼‰ã€‚

é‡‡æ ·ç»“æŸä»¥åï¼Œåœ¨å½“å‰ç›®å½•ä¸‹å°†ä¼šç”Ÿæˆä¸€ä¸ªé‡‡æ ·ç»“æœæ–‡ä»¶ `perf.data`ï¼ˆç”¨ `-o` å‚æ•°å¯ä»¥é‡å‘½åï¼‰ã€‚

## References

[Kernel Wiki - Sampling with perf record](https://perf.wiki.kernel.org/index.php/Tutorial#Sampling_with_perf_record)

[perf-record(1) â€” Linux manual page](https://man7.org/linux/man-pages/man1/perf-record.1.html)

[perf Examples](https://www.brendangregg.com/perf.html)
