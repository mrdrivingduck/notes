# Java - Deep Copy

Created by : Mr Dk.

2019 / 10 / 07 20:12

Nanjing, Jiangsu, China

---

## About

æœ€è¿‘åœ¨ç”¨ Java å®ç°ä¸€ä¸ª Fuzzer æ—¶ï¼Œå…¶ä¸­çš„ä¸€äº›ç®—æ³•éœ€è¦å¯¹å¯¹è±¡è¿›è¡Œæ‹·è´ã€‚ä¹‹å‰å†™ JavaScript çš„æ—¶å€™ï¼Œéƒ½æ˜¯ç›´æ¥ `JSON.parse()` + `JSON.stringfy()` å®Œäº‹äº†ï¼Œå¯¹äº Java åº”è¯¥æ€ä¹ˆå¤„ç†ä¸æ˜¯å¤ªäº†è§£ã€‚äºæ˜¯æœç´¢äº†ä¸€æ³¢ ğŸ™„ åå ‚è¿˜çœŸä¸å°‘ï¼Œä½†è‡³å°‘å¯ä»¥æ˜ç¡®çš„ä¸€ç‚¹æ˜¯ï¼šJSON ä¸æ˜¯ Java çš„åŸç”Ÿæ”¯æŒã€‚æ‰€ä»¥æ–¹æ³•æ˜¾ç„¶ä¸æ˜¯è½¬æˆ JSON å­—ç¬¦ä¸²å†è½¬å›æ¥ã€‚

## Clone Function

Java ä¸­çš„æ‰€æœ‰å¯¹è±¡å…¨éƒ¨ç»§æ‰¿è‡ª `java.lang.Object`ã€‚åœ¨è¿™ä¸ª root superclass ä¸­ï¼Œå®šä¹‰äº†ä¸€ä¸ª `clone()` å‡½æ•°ï¼Œå› æ­¤ä»»ä½•æ´¾ç”Ÿç±»éƒ½å¯ä»¥ override è¿™ä¸€ä¸ª `clone()` å‡½æ•°ã€‚è¯¥å‡½æ•°çš„é»˜è®¤è¡Œä¸ºæ˜¯ - è¿”å›ä¸€ä¸ªå¯¹è±¡çš„ **æµ…æ‹·è´**ï¼š

* å¤åˆ¶è¯¥å¯¹è±¡ä¸­çš„æ¯ä¸€ä¸ª field
* å¯¹äº **åŸå§‹æ•°æ®ç±»å‹** (`int`, `float`) æˆ– **ä¸å¯æ”¹å˜çš„ç±»å‹** (`String`) æ¥è¯´ï¼Œå¤åˆ¶çš„æ˜¯å€¼
* å¯¹äºå¯¹è±¡æ¥è¯´ï¼Œå¤åˆ¶çš„æ˜¯å¼•ç”¨ (æˆ‘å®æ„¿æŠŠå®ƒç†è§£ä¸ºï¼Œå¤åˆ¶çš„æ˜¯æŒ‡é’ˆ) - åªæ˜¯å¤åˆ¶äº†æŒ‡é’ˆï¼ŒæŒ‡é’ˆå˜æˆäº†ä¸¤ä¸ªï¼Œä½†æŒ‡å‘çš„åŒºåŸŸè¿˜æ˜¯åŒä¸€ä¸ª

æµ…æ‹·è´çš„é—®é¢˜æ˜¾è€Œæ˜“è§ï¼Œå¦‚æœé€šè¿‡å¤åˆ¶åçš„å¯¹è±¡ä¸­çš„å¯¹è±¡å¼•ç”¨ **ä¿®æ”¹** (åªè¯»åº”è¯¥ä¸ä¼šæœ‰é—®é¢˜) äº†å¯¹è±¡æ•°æ®ï¼Œé‚£ä¹ˆè¢«å¤åˆ¶å¯¹è±¡ä¸­çš„å¼•ç”¨çš„å¯¹è±¡æ•°æ®ä¹Ÿä¼šå‘ç”Ÿå˜åŒ–ã€‚å› ä¸ºä»–ä»¬å¼•ç”¨åŒä¸€ä¸ªå¯¹è±¡ã€‚ä¾‹å­ï¼š

```java
Vector original = new Vector();
StringBuffer text = new StringBuffer("A");
original.addElement(text);

Vector clone = (Vector) original.clone();
```

å®ä¾‹åŒ–ä¸€ä¸ª `Vector` å¯¹è±¡ï¼Œå¹¶å°†ä¸€ä¸ª `StringBuffer` å¯¹è±¡ä½œä¸ºå…ƒç´ åŠ å…¥åˆ°è¯¥å¯¹è±¡ä¸­ (å¼•ç”¨ä¼ é€’)ã€‚ç„¶åæµ…æ‹·è´ä¸€ä¸ª `Vector` å¯¹è±¡ï¼Œæ˜¾ç„¶ï¼Œé€šè¿‡ä¸¤ä¸ªå¯¹è±¡éƒ½å¯ä»¥è®¿é—®åˆ° `StringBuffer` å¯¹è±¡ï¼Œå…‹éš†çœ‹èµ·æ¥æ˜¯æˆåŠŸçš„ã€‚

```java
clone.addElement(new Integer(5));
```

æ­¤æ—¶ï¼Œè®¿é—®è¿™ä¸¤ä¸ªå¯¹è±¡ï¼Œ `clone` å¯ä»¥è®¿é—®åˆ° `Integer`ï¼Œè€Œ `original` ä¸è¡Œã€‚å› ä¸ºè¿™ä¸¤ä¸ª `Vector` ç°åœ¨ç¡®å®æ˜¯ä¸¤ä¸ªç‹¬ç«‹çš„å¯¹è±¡äº†ã€‚`clone` å¯¹è±¡æŒæœ‰å¯¹ `Integer` å¯¹è±¡çš„å¼•ç”¨ï¼Œè€Œ `original` å¯¹è±¡æ²¡æœ‰ã€‚

```java
text.append("EMMM");
```

æ­¤æ—¶ï¼Œé€šè¿‡ä¸¤ä¸ª `Vector` å¯¹è±¡è®¿é—® `text`ï¼Œå‘ç°ä¸¤ä¸ªå¯¹è±¡ä¸­çš„ `text` å¯¹è±¡éƒ½å˜äº†ã€‚å› ä¸ºè¿™ä¸¤ä¸ª `Vector` å¯¹è±¡æŒæœ‰å¯¹åŒä¸€ä¸ª `StringBuffer` å¯¹è±¡çš„å¼•ç”¨ã€‚

> ä¹Ÿå°±æ˜¯è¯´ï¼Œæµ…æ‹·è´åªæ˜¯å¤åˆ¶äº† **æŒ‡é’ˆ**ï¼Œè€ŒæŒ‡é’ˆæŒ‡å‘çš„å¯¹è±¡æ²¡æœ‰è¢«å¤åˆ¶ã€‚å› æ­¤ï¼Œé€šè¿‡ `origin` å¯¹è±¡ä¿®æ”¹äº† `StringBuffer` å¯¹è±¡åï¼Œé€šè¿‡ `clone` å¯¹è±¡è®¿é—® `StringBuffer` å¯¹è±¡æ—¶ï¼Œèƒ½å¤Ÿçœ‹åˆ°ä¿®æ”¹ã€‚
>

so. å¦‚æœä¸šåŠ¡é€»è¾‘éœ€è¦çš„æ˜¯æŠŠ `StringBuffer` å¯¹è±¡ä¹Ÿå¤åˆ¶ä¸¤ä»½ï¼Œå³éœ€è¦è¿›è¡Œæ‰€è°“çš„ **deep copy**ï¼Œhow to do it?

---

## Issues

æˆ–è®¸å¯ä»¥è‡ªå·±å®ç°ä¸€ä¸ª `deepCopy()` å‡½æ•°ï¼Œä»¥å®Œæˆå¤æ‚çš„æ·±æ‹·è´åŠŸèƒ½ï¼Ÿ

1. å¿…é¡»æœ‰è¿™ä¸ªç±»çš„æºä»£ç æ‰è¡Œ - å¦‚æœæƒ³å¤åˆ¶ä¸€ä¸ªç¬¬ä¸‰æ–¹çš„ç±»ï¼Œæˆ–è®¸å¯èƒ½è¢«å£°æ˜ä¸º `final` - Well...GG ğŸ˜¥
2. å¿…é¡»èƒ½å¤Ÿè®¿é—®è¿™ä¸ªç±»çš„åŸºç±»çš„æ‰€æœ‰ field - å¦‚æœåŸºç±»çš„ field è¢«å£°æ˜ä¸º `private` - Well...GG again ğŸ˜¥
3. å¿…é¡»èƒ½å¤Ÿæ‹·è´è¯¥ç±»å¼•ç”¨çš„æ‰€æœ‰ç±»å‹çš„å¯¹è±¡æ‰è¡Œ - ä½†æœ‰äº›ç±»å‹åªæœ‰åœ¨è¿è¡Œæ—¶æ‰èƒ½è¢«æ˜ç¡®
4. å¾ˆå®¹æ˜“å‡ºé”™ï¼Œéš¾äºç»´æŠ¤ - ä¸€æ—¦è¿™ä¸ªç±»çš„ç»“æ„è¢«æ”¹åŠ¨äº†ï¼Œéƒ½è¦æ£€æŸ¥ä¸€éè¿™ä¸ªå‡½æ•°

æ­¤å¤–ï¼Œé‡å†™ `clone()` å‡½æ•°åœ¨ *StackOverFlow* ä¸Šä¹Ÿä¸è¢«æ¨èï¼Œå› ä¸ºæ·±åº¦å¤åˆ¶åº”å½“æ˜¯ä¸€ä¸ªé€’å½’çš„è¿‡ç¨‹ã€‚è‡³å°‘åœ¨å®ç° `clone()` å‡½æ•°æ—¶ï¼Œè¯¥å¯¹è±¡å¼•ç”¨çš„æ‰€æœ‰ç±»å‹çš„å¯¹è±¡ä¹Ÿåº”å½“éƒ½è¦†ç›– `clone()`ï¼Œä¸ç„¶æ€»ä¼šæœ‰è¢«è¯¥ç±»å¼•ç”¨çš„å¯¹è±¡æ˜¯æµ…æ‹·è´ã€‚

> emm... ğŸ¤” æœ‰é“ç†å•Š...

---

## Solution

æ‰€ä»¥å¸¸ç”¨çš„è§£å†³æ–¹æ¡ˆæ˜¯ä½¿ç”¨ *Java Object Serialization (JOS)*ï¼Œå³åºåˆ—åŒ–å’Œååºåˆ—åŒ–ã€‚ä»å­—èŠ‚å±‚é¢ï¼ŒæŠŠæ•´ä¸ªå¯¹è±¡å¤åˆ¶ä¸€ä»½ã€‚æ›´é‡è¦çš„æ˜¯ï¼ŒJOS è´Ÿè´£å…¶ä¸­çš„æ‰€æœ‰ç»†èŠ‚ï¼š

* çˆ¶ç±»ä¸­çš„ field
* è·Ÿéš object graphs å¹¶èƒ½å¤Ÿé€’å½’åœ°å¤åˆ¶å¼•ç”¨çš„æ‰€æœ‰å¯¹è±¡

> æ„æ€æ˜¯åªç®¡åºåˆ—åŒ– / ååºåˆ—åŒ–å°±è¡Œï¼Œä¸ç”¨ç®¡åµŒå¥—å¯¹è±¡çš„é—®é¢˜ã€‚

```java
Object orig;
Object obj = null;

ByteArrayOutputStream bos = new ByteArrayOutputStream();
ObjectOutputStream out = new ObjectOutputStream(bos);
out.writeObject(orig);
out.flush();
out.close();

ObjectInputStream in = new ObjectInputStream(
    new ByteArrayInputStream(bos.toByteArray()));
obj = in.readObject();
```

ä½†ä¹Ÿå­˜åœ¨é—®é¢˜ï¼š

* è¢«æ‹·è´çš„å¯¹è±¡ (åŒ…æ‹¬åµŒå¥—åœ¨å†…çš„) å¿…é¡»å®ç° `java.io.Serializable` - å³ï¼Œå¿…é¡»æ˜¯å¯åºåˆ—åŒ–çš„

  > é‚£ç¬¬ä¸‰æ–¹çš„å¯¹è±¡ä¸‡ä¸€æ— æ³•è¢«åºåˆ—åŒ–å’‹åŠå‘¢ï¼Ÿå®ƒæ²¡æœ‰å®ç° `java.io.Serializable` æ¥å£ï¼Œæˆ‘è¿˜è¦ä¿®æ”¹å®ƒçš„æºä»£ç ä¸æˆï¼Ÿï¼Ÿ
  >
  
* JOS æ¯”è¾ƒæ…¢

* Byte array stream çš„å®ç°æ˜¯ **çº¿ç¨‹å®‰å…¨** çš„ï¼Œå› æ­¤ä¼šæœ‰ä¸€äº›é¢å¤–çš„å¼€é”€

å¯èƒ½çš„ä¼˜åŒ–æ–¹å¼ï¼š

1. `ByteArrayOutputStream` é»˜è®¤ä¼šåˆå§‹åŒ– 32 å­—èŠ‚çš„æ•°ç»„ï¼Œç„¶ååŠ¨æ€å¢é•¿ - é‚£ä¹ˆå¯ä»¥ç”¨æ›´å¤§çš„å€¼åˆå§‹åŒ–
2. `ByteArrayOutputStream` çš„æ‰€æœ‰å‡½æ•°éƒ½æ˜¯ `synchronized` çš„ - ç”±äºæˆ‘ä»¬ç¡®ä¿æ˜¯åœ¨å•çº¿ç¨‹ä¸­æ‰§è¡Œï¼ŒåŒæ­¥å…³é”®å­—å¯ä»¥å»æ‰
3. `toByteArray()` ä¼šè¿”å› stream çš„å­—èŠ‚æ•°ç»„çš„ä¸€ä»½æ‹·è´ - æµªè´¹ç©ºé—´å’Œæ—¶é—´

---

## Reference

[Java Techniques - Faster Deep Copies of Java Objects](http://javatechniques.com/blog/faster-deep-copies-of-java-objects/)

## Summary

è¿˜æ˜¯éœ€è¦å¤šè¯»è¯» JDK æºç ã€‚

---

